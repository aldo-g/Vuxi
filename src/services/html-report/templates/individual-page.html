{% extends "base.html" %}

{% block content %}
<h1>{{ page_title }}</h1>

<div class="info-grid">
    <div class="info-card">
        <div class="info-label">Page Type</div>
        <div class="info-value">{{ page_type }}</div>
    </div>
    <div class="info-card">
        <div class="info-label">Page URL</div>
        <div class="info-value" style="word-break: break-all;">{{ page_url }}</div>
    </div>
    <div class="info-card">
        <div class="info-label">Analysis Date</div>
        <div class="info-value">{{ analysis_date }}</div>
    </div>
</div>

<!-- Overall Score Bar Chart -->
<div class="section">
    <h2>Overall Page Score</h2>
    <div class="score-summary">
        <div class="overall-score-container">
            <div class="score-bar-large">
                <div class="score-bar-fill" data-score="{{ page_analysis.overall_score }}"></div>
                <div class="score-text">
                    <span class="score-number">{{ page_analysis.overall_score }}</span>
                    <span class="score-label">out of 10</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Page Summary -->
<div class="section">
    <h2>Page Summary</h2>
    <div class="analysis-result">
        <p style="font-size: 1.1em; line-height: 1.7; background-color: #f0fdf4; padding: 15px; border-radius: 6px; border-left: 4px solid #10b981;">
            {{ page_analysis.summary }}
        </p>
    </div>
</div>

<!-- Tab navigation -->
<div class="tabs">
    <div class="tab active" data-tab="tab-detailed">Detailed Analysis</div>
    <div class="tab" data-tab="tab-issues">Key Issues</div>
    <div class="tab" data-tab="tab-recommendations">Recommendations</div>
    <div class="tab" data-tab="tab-raw">Raw Analysis</div>
</div>

<!-- Detailed Analysis Tab -->
<div id="tab-detailed" class="tab-content active">
    <div class="section">
        <h2>Comprehensive Page Analysis</h2>
        {% if page_analysis.cleaned_analysis %}
        <div class="detailed-analysis-content" 
             data-section-scores="{{ page_analysis.section_scores | tojson }}">
            {{ page_analysis.cleaned_analysis | safe }}
        </div>
        {% else %}
        <p>No detailed analysis available for this page.</p>
        {% endif %}
    </div>
</div>

<!-- Key Issues Tab -->
<div id="tab-issues" class="tab-content">
    {% if page_analysis.key_issues and page_analysis.key_issues.length > 0 %}
    <div class="section">
        <h2>Key Issues Identified</h2>
        {% for issue in page_analysis.key_issues %}
        <div class="critical-issue" style="margin-bottom: 15px;">
            <strong>{{ loop.index }}.</strong> {{ issue }}
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="section">
        <div style="padding: 20px; background-color: #f0fdf4; border-radius: 6px; border-left: 4px solid #10b981;">
            <p><strong>‚úÖ No critical issues identified</strong></p>
            <p>This page appears to be functioning well without major usability or conversion problems.</p>
        </div>
    </div>
    {% endif %}
</div>

<!-- Recommendations Tab -->
<div id="tab-recommendations" class="tab-content">
    {% if page_analysis.recommendations and page_analysis.recommendations.length > 0 %}
    <div class="section">
        <h2>Recommended Improvements</h2>
        {% for recommendation in page_analysis.recommendations %}
        <div class="recommendation" style="margin-bottom: 15px;">
            <strong>{{ loop.index }}.</strong> {{ recommendation }}
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="section">
        <p>No specific recommendations were provided for this page.</p>
    </div>
    {% endif %}
</div>

<!-- Raw Analysis Tab -->
<div id="tab-raw" class="tab-content">
    <div class="section">
        <h2>Complete Raw Analysis Data</h2>
        {% if page_analysis.original_analysis %}
        <div class="analysis-result">
            <pre style="white-space: pre-wrap; word-wrap: break-word; background-color: #f8f9fa; padding: 20px; border-radius: 6px; border: 1px solid #e9ecef; font-size: 0.9em; line-height: 1.4;">{{ page_analysis.original_analysis }}</pre>
        </div>
        {% else %}
        <p>No raw analysis data available for this page.</p>
        {% endif %}
    </div>
</div>

<!-- Screenshot - Moved to bottom -->
<div class="section">
    <h2>Page Screenshot</h2>
    <div class="screenshot-container">
        <img src="screenshots/{{ screenshot_path }}" alt="{{ page_type }}" class="screenshot" 
             style="max-width: 100%; border: 2px solid #e2e8f0; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"
             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
        <div style="display: none; padding: 20px; background-color: #f3f4f6; border-radius: 8px; text-align: center; color: #6b7280;">
            Screenshot not available: {{ screenshot_path }}
        </div>
    </div>
</div>

<div class="navigation" style="margin-top: 30px;">
    <a href="overview.html">‚Üê Back to Overview</a>
</div>

<style>
/* Overall Score Styles */
.score-summary {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 30px;
    background-color: #f8fafc;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
}

.overall-score-container {
    width: 100%;
    max-width: 500px;
}

.score-bar-large {
    position: relative;
    height: 60px;
    background-color: #e5e7eb;
    border-radius: 30px;
    overflow: hidden;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
}

.score-bar-fill {
    height: 100%;
    border-radius: 30px;
    transition: width 1s ease;
    position: relative;
}

.score-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    display: flex;
    flex-direction: column;
    align-items: center;
    z-index: 10;
    color: white;
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
}

.score-number {
    font-size: 1.8rem;
    font-weight: bold;
    line-height: 1;
}

.score-label {
    font-size: 0.9rem;
    line-height: 1;
}

/* Inline Section Bar Chart Styles */
.section-bar-container {
    margin: 20px 0;
    padding: 20px;
    background-color: #f8fafc;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
}

.section-bar-item {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
}

.section-bar-label {
    min-width: 120px;
    font-size: 0.9rem;
    font-weight: 600;
    color: #374151;
    margin-right: 15px;
}

.section-bar {
    flex: 1;
    height: 30px;
    background-color: #e5e7eb;
    border-radius: 15px;
    overflow: hidden;
    position: relative;
    margin-right: 15px;
}

.section-bar-fill {
    height: 100%;
    border-radius: 15px;
    transition: width 0.8s ease;
    position: relative;
}

.section-score-text {
    position: absolute;
    top: 50%;
    right: 10px;
    transform: translateY(-50%);
    color: white;
    font-weight: bold;
    font-size: 0.85rem;
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    z-index: 5;
}

.section-score-value {
    min-width: 45px;
    text-align: center;
    font-weight: bold;
    font-size: 0.9rem;
}

/* Color classes for different score ranges */
.score-good {
    background-color: #10b981;
    color: #10b981;
}

.score-average {
    background-color: #f59e0b;
    color: #f59e0b;
}

.score-poor {
    background-color: #ef4444;
    color: #ef4444;
}

.detailed-analysis-content {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    line-height: 1.6;
    color: #334155;
}

.page-role-section {
    background-color: #f8fafc;
    padding: 20px;
    border-radius: 8px;
    border-left: 4px solid #3b82f6;
    margin-bottom: 30px;
}

.page-role-section h3 {
    color: #1e293b;
    margin-top: 0;
    margin-bottom: 15px;
    font-size: 1.3em;
    font-weight: 600;
}

.page-role-content p {
    margin-bottom: 10px;
    color: #475569;
}

.analysis-main {
    color: #1e293b;
    font-size: 1.4em;
    font-weight: 600;
    margin-top: 30px;
    margin-bottom: 15px;
    padding-bottom: 8px;
    border-bottom: 2px solid #e2e8f0;
}

.analysis-section {
    color: #2563eb;
    font-size: 1.2em;
    font-weight: 600;
    margin-top: 25px;
    margin-bottom: 12px;
}

.analysis-point {
    margin: 8px 0;
    margin-left: 20px;
    color: #475569;
    position: relative;
}

.analysis-point::before {
    content: "‚Ä¢";
    color: #64748b;
    position: absolute;
    left: -15px;
}

.evidence-section {
    background-color: #f1f5f9;
    padding: 12px;
    border-radius: 6px;
    margin: 15px 0;
    border-left: 3px solid #64748b;
    font-size: 0.95em;
}

.evidence-section strong {
    color: #334155;
}

/* Completely override any inherited list styling */
.detailed-analysis-content * {
    list-style: none !important;
    list-style-type: none !important;
}

.detailed-analysis-content p {
    margin-bottom: 8px;
    color: #475569;
}

@media (max-width: 768px) {
    .score-summary {
        padding: 20px;
    }
    
    .score-bar-large {
        height: 50px;
    }
    
    .score-number {
        font-size: 1.5rem;
    }
    
    .section-bar-item {
        flex-direction: column;
        align-items: stretch;
        margin-bottom: 15px;
    }
    
    .section-bar-label {
        min-width: auto;
        margin-bottom: 8px;
        margin-right: 0;
    }
    
    .section-bar {
        margin-right: 0;
        margin-bottom: 5px;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('üéØ Initializing score bars...');
    
    // Function to get color based on score
    function getScoreColor(score) {
        if (score >= 8) return '#10b981'; // Green
        if (score >= 6) return '#f59e0b'; // Yellow/Orange
        return '#ef4444'; // Red
    }
    
    // Function to get score class
    function getScoreClass(score) {
        if (score >= 8) return 'score-good';
        if (score >= 6) return 'score-average';
        return 'score-poor';
    }
    
    // Function to create section bar chart HTML
    function createSectionBar(score, sectionName) {
        const color = getScoreColor(score);
        const scoreClass = getScoreClass(score);
        
        return `
            <div class="section-bar-container">
                <div class="section-bar-item">
                    <div class="section-bar-label">${sectionName}</div>
                    <div class="section-bar">
                        <div class="section-bar-fill ${scoreClass}" 
                             data-score="${score}" 
                             style="background-color: ${color}; width: 0%;">
                            <div class="section-score-text">${score}/10</div>
                        </div>
                    </div>
                    <div class="section-score-value ${scoreClass}">${score}/10</div>
                </div>
            </div>
        `;
    }
    
    // Initialize overall score bar
    const overallScoreBar = document.querySelector('.score-bar-fill[data-score]');
    if (overallScoreBar) {
        const score = parseInt(overallScoreBar.getAttribute('data-score'));
        const percentage = (score / 10) * 100;
        const color = getScoreColor(score);
        
        setTimeout(() => {
            overallScoreBar.style.width = percentage + '%';
            overallScoreBar.style.backgroundColor = color;
        }, 500);
    }
    
    // Process the detailed analysis content
    const analysisContent = document.querySelector('.detailed-analysis-content');
    if (analysisContent) {
        // Get section scores from data attribute
        const sectionScoresData = analysisContent.getAttribute('data-section-scores');
        let sectionScores = {};
        
        try {
            sectionScores = JSON.parse(sectionScoresData) || {};
            console.log('üìä Section scores loaded:', sectionScores);
        } catch (e) {
            console.log('‚ö†Ô∏è No section scores data found or invalid JSON');
        }
        
        let html = analysisContent.innerHTML;
        
        // Convert markdown-style formatting to HTML
        html = html.replace(/## PAGE ROLE ANALYSIS:/g, '<div class="page-role-section"><h3>üìã Page Role Analysis</h3><div class="page-role-content">');
        html = html.replace(/## (\d+)\. ([^:]+):/g, '<div class="analysis-main">$1. $2</div>');
        html = html.replace(/- (EVIDENCE:.*)/g, '<div class="evidence-section"><strong>$1</strong></div>');
        html = html.replace(/- ([^E].*)/g, '<div class="analysis-point">$1</div>');
        html = html.replace(/# ([^#].*)/g, '<div class="analysis-section">$1</div>');
        
        // Close any open page-role-section
        if (html.includes('page-role-section')) {
            html = html.replace(/(<div class="page-role-content">.*?)(<div class="analysis-main">)/s, '$1</div></div>$2');
        }
        
        // Insert bar charts after each section heading with improved matching
        const sectionMapping = {
            'FIRST IMPRESSION & CLARITY': 'first_impression_clarity',
            'GOAL ALIGNMENT': 'goal_alignment',
            'VISUAL DESIGN': 'visual_design',
            'CONTENT QUALITY': 'content_quality',
            'USABILITY & ACCESSIBILITY': 'usability_accessibility',
            'CONVERSION OPTIMIZATION': 'conversion_optimization',
            'TECHNICAL EXECUTION': 'technical_execution',
        };
        
        // Process each section with more flexible matching
        for (const [sectionName, scoreKey] of Object.entries(sectionMapping)) {
            if (sectionScores[scoreKey]) {
                const score = sectionScores[scoreKey];
                console.log(`üéØ Processing section: ${sectionName} = ${score}`);
                
                // More flexible pattern matching
                const patterns = [
                    new RegExp(`(<div class="analysis-main">[^<]*${sectionName}[^<]*</div>)`, 'i'),
                    new RegExp(`(<div class="analysis-main">[^<]*${sectionName.split(' ')[0]}[^<]*</div>)`, 'i'),
                    new RegExp(`(<div class="analysis-main">[^<]*\\d+\\.[^<]*${sectionName.split(' ')[0]}[^<]*</div>)`, 'i')
                ];
                
                for (const pattern of patterns) {
                    if (pattern.test(html)) {
                        const barHTML = createSectionBar(score, sectionName);
                        html = html.replace(pattern, `$1${barHTML}`);
                        console.log(`‚úÖ Inserted bar for: ${sectionName}`);
                        break;
                    }
                }
            }
        }
        
        analysisContent.innerHTML = html;
        
        // Animate section bars
        setTimeout(() => {
            const sectionBars = document.querySelectorAll('.section-bar-fill[data-score]');
            sectionBars.forEach(bar => {
                const score = parseInt(bar.getAttribute('data-score'));
                const percentage = (score / 10) * 100;
                bar.style.width = percentage + '%';
            });
        }, 1000);
    }
    
    // Tab functionality
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            // Remove active class from all tabs and contents
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(c => c.classList.remove('active'));
            
            // Add active class to clicked tab and corresponding content
            tab.classList.add('active');
            const tabId = tab.getAttribute('data-tab');
            const targetContent = document.getElementById(tabId);
            if (targetContent) {
                targetContent.classList.add('active');
            }
        });
    });
});
</script>
{% endblock %}